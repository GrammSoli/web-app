{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}–†–∞—Å—Å—ã–ª–∫–∏ | {{ site_title }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .broadcasts-container {
        padding: 0;
    }
    
    /* –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ */
    .back-btn:hover {
        background: var(--color-bg-secondary, #f3f4f6) !important;
        transform: translateX(-2px);
    }
    
    /* –°–µ–∫—Ü–∏–∏ */
    .broadcasts-section {
        margin-bottom: 32px;
    }
    
    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--color-text-primary, #1f2937);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* KPI –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }
    
    .kpi-card {
        background: var(--color-bg-primary, #fff);
        border-radius: 12px;
        padding: 20px 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    
    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }
    
    .kpi-card.primary::before { background: linear-gradient(90deg, #8B5CF6, #A78BFA); }
    .kpi-card.success::before { background: linear-gradient(90deg, #10B981, #34D399); }
    .kpi-card.warning::before { background: linear-gradient(90deg, #F59E0B, #FBBF24); }
    .kpi-card.danger::before { background: linear-gradient(90deg, #EF4444, #F87171); }
    
    .kpi-label {
        font-size: 13px;
        color: var(--color-text-secondary, #6b7280);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    
    .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--color-text-primary, #1f2937);
        line-height: 1.2;
    }
    
    /* –ö–æ–Ω—Ç–µ–Ω—Ç –≥—Ä–∏–¥ */
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 24px;
    }
    
    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
    .card {
        background: var(--color-bg-primary, #fff);
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .card-header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--color-border, #e5e7eb);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--color-text-primary, #1f2937);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .card-badge {
        background: #8B5CF6;
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .card-body {
        padding: 24px;
    }
    
    /* –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Å—ã–ª–æ–∫ */
    .broadcast-list {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .broadcast-item {
        padding: 16px 24px;
        border-bottom: 1px solid var(--color-border, #e5e7eb);
        transition: background 0.2s;
    }
    
    .broadcast-item:last-child {
        border-bottom: none;
    }
    
    .broadcast-item:hover {
        background: var(--color-bg-secondary, #f9fafb);
    }
    
    .broadcast-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .broadcast-title-wrap {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        min-width: 0;
    }
    
    .broadcast-title {
        font-weight: 600;
        color: var(--color-text-primary, #1f2937);
        font-size: 16px;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .broadcast-date {
        font-size: 12px;
        color: var(--color-text-secondary, #9ca3af);
        white-space: nowrap;
    }
    
    .broadcast-right {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
    }
    
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
    }
    
    .status-draft { background: #F3F4F6; color: #6B7280; }
    .status-scheduled { background: #DBEAFE; color: #2563EB; }
    .status-sending { background: #FEF3C7; color: #D97706; }
    .status-sent { background: #D1FAE5; color: #059669; }
    .status-failed { background: #FEE2E2; color: #DC2626; }
    
    .broadcast-body {
        display: flex;
        gap: 14px;
    }
    
    .broadcast-text {
        font-size: 14px;
        color: var(--color-text-secondary, #6b7280);
        line-height: 1.6;
        flex: 1;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .broadcast-meta {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 13px;
        color: var(--color-text-secondary, #6b7280);
        margin-top: 10px;
    }
    
    .broadcast-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--color-border, #e5e7eb);
    }
    
    .broadcast-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-delete-icon {
        background: transparent;
        border: none;
        color: var(--color-text-secondary, #9ca3af);
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s;
        font-size: 16px;
    }
    
    .btn-delete-icon:hover {
        background: #FEE2E2;
        color: #DC2626;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        text-decoration: none;
    }
    
    .btn-launch {
        background: #10B981;
        color: white;
    }
    
    .btn-launch:hover {
        background: #059669;
        transform: translateY(-1px);
    }
    
    .btn-delete {
        background: #FEE2E2;
        color: #DC2626;
    }
    
    .btn-delete:hover {
        background: #FECACA;
    }
    
    .btn-create {
        width: 100%;
        padding: 14px 20px;
        background: linear-gradient(90deg, #8B5CF6, #A78BFA);
        color: white;
        font-size: 15px;
    }
    
    .btn-create:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    
    /* –ü—Ä–æ–≥—Ä–µ—Å—Å */
    .progress-bar {
        height: 6px;
        background: var(--color-border, #e5e7eb);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 6px;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10B981, #34D399);
        transition: width 0.3s;
    }
    
    .progress-text {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--color-text-secondary, #6b7280);
    }
    
    /* –ú–∏–Ω–∏–∞—Ç—é—Ä–∞ */
    .broadcast-thumbnail {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        margin-right: 12px;
        flex-shrink: 0;
    }
    
    .broadcast-content {
        flex: 1;
        min-width: 0;
    }
    
    .broadcast-row {
        display: flex;
        align-items: flex-start;
    }
    
    /* Image Upload */
    .image-upload-area {
        border: 2px dashed var(--color-border, #e5e7eb);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    
    .image-upload-area:hover,
    .image-upload-area.dragover {
        border-color: #8B5CF6;
        background: rgba(139, 92, 246, 0.05);
    }
    
    .image-preview {
        position: relative;
        display: inline-block;
    }
    
    .image-preview img {
        max-width: 100%;
        max-height: 150px;
        border-radius: 6px;
    }
    
    .remove-image {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: #DC2626;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }
    
    .remove-image:hover {
        background: #B91C1C;
    }
    
    .remove-image {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: #EF4444;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        display: none;
    }
    
    .image-upload-area.has-image .remove-image {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .image-upload-area.has-image .upload-placeholder {
        display: none;
    }
    
    /* –§–æ—Ä–º–∞ */
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-label {
        display: block;
        font-size: 13px;
        color: var(--color-text-secondary, #6b7280);
        margin-bottom: 6px;
        font-weight: 500;
    }
    
    .form-input,
    .form-textarea,
    .form-select {
        width: 100%;
        padding: 10px 14px;
        background: var(--color-bg-primary, #fff);
        border: 1px solid var(--color-border, #e5e7eb);
        border-radius: 8px;
        color: var(--color-text-primary, #1f2937);
        font-size: 14px;
        transition: border-color 0.2s;
        box-sizing: border-box;
    }
    
    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
        outline: none;
        border-color: #8B5CF6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .form-textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
    }
    
    .form-hint {
        font-size: 12px;
        color: var(--color-text-secondary, #9ca3af);
        margin-top: 4px;
    }
    
    /* Empty State */
    .empty-state {
        padding: 48px 24px;
        text-align: center;
    }
    
    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }
    
    .empty-text {
        color: var(--color-text-secondary, #6b7280);
        font-size: 14px;
    }
    
    /* Alerts */
    .alerts-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .alert {
        padding: 12px 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease;
        min-width: 280px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .alert-success {
        background: #D1FAE5;
        color: #065F46;
    }
    
    .alert-error {
        background: #FEE2E2;
        color: #991B1B;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .kpi-grid { grid-template-columns: repeat(2, 1fr); }
        .content-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="broadcasts-container">
    
    <!-- –®–∞–ø–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π –Ω–∞–∑–∞–¥ -->
    <div class="broadcasts-header" style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
        <a href="/admin/" class="back-btn" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: var(--color-bg-primary, #fff); border-radius: 10px; text-decoration: none; color: var(--color-text-primary, #374151); font-weight: 500; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;">
            <span style="font-size: 18px;">‚Üê</span> –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É
        </a>
        <h1 style="margin: 0; font-size: 24px; font-weight: 700; color: var(--color-text-primary, #1f2937);">üì¢ –†–∞—Å—Å—ã–ª–∫–∏</h1>
        <button onclick="location.reload()" style="margin-left: auto; padding: 10px 16px; background: var(--color-bg-primary, #fff); border: 1px solid var(--color-border, #e5e7eb); border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--color-text-primary, #374151);">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    
    <!-- Alerts Container -->
    <div class="alerts-container" id="alerts"></div>
    
    <!-- KPI -->
    <section class="broadcasts-section">
        <h2 class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="kpi-grid">
            <div class="kpi-card primary">
                <div class="kpi-label">–í—Å–µ–≥–æ —Ä–∞—Å—Å—ã–ª–æ–∫</div>
                <div class="kpi-value">{{ stats.total }}</div>
            </div>
            <div class="kpi-card success">
                <div class="kpi-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                <div class="kpi-value">{{ stats.total_sent }}</div>
            </div>
            <div class="kpi-card warning">
                <div class="kpi-label">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                <div class="kpi-value">{{ stats.in_progress }}</div>
            </div>
            <div class="kpi-card danger">
                <div class="kpi-label">–û—à–∏–±–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏</div>
                <div class="kpi-value">{{ stats.total_failed }}</div>
            </div>
        </div>
    </section>
    
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <section class="broadcasts-section">
        <div class="content-grid">
            <!-- –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Å—ã–ª–æ–∫ -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìã –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Å—ã–ª–æ–∫</span>
                    <span class="card-badge">{{ broadcasts|length }}</span>
                </div>
                <div class="broadcast-list">
                    {% if broadcasts %}
                        {% for b in broadcasts %}
                        <div class="broadcast-item" id="broadcast-{{ b.id }}">
                            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫: –Ω–∞–∑–≤–∞–Ω–∏–µ + –¥–∞—Ç–∞ + —Å—Ç–∞—Ç—É—Å + —É–¥–∞–ª–∏—Ç—å -->
                            <div class="broadcast-header">
                                <div class="broadcast-title-wrap">
                                    <h3 class="broadcast-title">{{ b.title }}</h3>
                                    <span class="broadcast-date">{{ b.date_created|date:"d.m.Y H:i" }}</span>
                                </div>
                                <div class="broadcast-right">
                                    <span class="status-badge status-{{ b.status }}">
                                        {% if b.status == 'draft' %}–ß–µ—Ä–Ω–æ–≤–∏–∫
                                        {% elif b.status == 'scheduled' %}–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞
                                        {% elif b.status == 'sending' %}–û—Ç–ø—Ä–∞–≤–∫–∞...
                                        {% elif b.status == 'sent' %}–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
                                        {% else %}–û—à–∏–±–∫–∞{% endif %}
                                    </span>
                                    {% if b.status != 'sending' %}
                                    <button class="btn-delete-icon" onclick="deleteBroadcast('{{ b.id }}')" title="–£–¥–∞–ª–∏—Ç—å">
                                        üóëÔ∏è
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- –¢–µ–ª–æ: –∫–∞—Ä—Ç–∏–Ω–∫–∞ + —Ç–µ–∫—Å—Ç -->
                            <div class="broadcast-body">
                                {% if b.message_photo_url %}
                                <img src="{{ b.message_photo_url }}" alt="" class="broadcast-thumbnail">
                                {% endif %}
                                <div class="broadcast-text">{{ b.message_text|truncatechars:150 }}</div>
                            </div>
                            
                            <!-- –ú–µ—Ç–∞: –∞—É–¥–∏—Ç–æ—Ä–∏—è + –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ -->
                            <div class="broadcast-meta">
                                <span>üë• {{ b.get_target_audience_display }}</span>
                                {% if b.scheduled_at %}
                                <span>‚è∞ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: {{ b.scheduled_at|date:"d.m.Y H:i" }}</span>
                                {% endif %}
                            </div>
                            
                            <!-- –§—É—Ç–µ—Ä: –ø—Ä–æ–≥—Ä–µ—Å—Å + –∫–Ω–æ–ø–∫–∏ -->
                            {% if b.total_recipients or b.status == 'draft' or b.status == 'scheduled' or b.status == 'failed' %}
                            <div class="broadcast-footer">
                                {% if b.total_recipients %}
                                <div style="flex: 1; margin-right: 16px;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {% widthratio b.sent_count b.total_recipients 100 %}%"></div>
                                    </div>
                                    <div class="progress-text">
                                        <span>{{ b.sent_count }} / {{ b.total_recipients }} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
                                        <span>{{ b.failed_count }} –æ—à–∏–±–æ–∫</span>
                                    </div>
                                </div>
                                {% else %}
                                <div></div>
                                {% endif %}
                                
                                <div class="broadcast-actions">
                                    {% if b.status == 'draft' or b.status == 'scheduled' or b.status == 'failed' %}
                                    <button class="btn btn-launch" onclick="launchBroadcast('{{ b.id }}')">
                                        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-text">–ù–µ—Ç —Ä–∞—Å—Å—ã–ª–æ–∫. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">‚ú® –ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</span>
                </div>
                <div class="card-body">
                    <form id="create-form" onsubmit="createBroadcast(event)">
                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input type="text" name="title" class="form-input" placeholder="–ù–æ–≤–æ–≥–æ–¥–Ω—è—è –∞–∫—Ü–∏—è" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è *</label>
                            <textarea name="message_text" class="form-textarea" placeholder="–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏..." required></textarea>
                            <div class="form-hint">–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: &lt;b&gt;–∂–∏—Ä–Ω—ã–π&lt;/b&gt;, &lt;i&gt;–∫—É—Ä—Å–∏–≤&lt;/i&gt;, &lt;code&gt;–∫–æ–¥&lt;/code&gt;, &lt;s&gt;–∑–∞—á—ë—Ä–∫–Ω—É—Ç–æ&lt;/s&gt;</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                            <input type="hidden" name="message_photo_url" id="photo-url-input">
                            <div class="image-upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                                <div id="upload-placeholder">
                                    <div style="font-size: 32px; margin-bottom: 8px;">üì∑</div>
                                    <div>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
                                    <div class="form-hint">JPG, PNG, GIF, WebP –¥–æ 10 –ú–ë</div>
                                </div>
                                <div id="image-preview" class="image-preview" style="display: none;">
                                    <img id="preview-img" src="" alt="Preview">
                                    <button type="button" class="remove-image" onclick="event.stopPropagation(); removeImage()">√ó</button>
                                </div>
                            </div>
                            <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
                            <select name="target_audience" class="form-select">
                                <option value="all">üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                                <option value="premium">‚≠ê Premium</option>
                                <option value="free">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞</label>
                            <input type="datetime-local" name="scheduled_at" class="form-input">
                            <div class="form-hint">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Ä—É—á–Ω—É—é</div>
                        </div>
                        
                        <button type="submit" class="btn btn-create" id="submit-btn">
                            ‚ú® –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
const csrfToken = '{{ csrf_token }}';

function showAlert(message, type = 'success') {
    const container = document.getElementById('alerts');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    container.appendChild(alert);
    setTimeout(() => alert.remove(), 4000);
}

async function createBroadcast(e) {
    e.preventDefault();
    const form = document.getElementById('create-form');
    const btn = document.getElementById('submit-btn');
    const formData = new FormData(form);
    
    btn.disabled = true;
    btn.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';
    
    try {
        const res = await fetch('/admin/broadcasts/api/create/', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });
        const data = await res.json();
        
        if (data.success) {
            showAlert('‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
            form.reset();
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error || '–û—à–∏–±–∫–∞', 'error');
        }
    } catch (err) {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = '‚ú® –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';
    }
}

async function launchBroadcast(id) {
    if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?')) return;
    
    try {
        const res = await fetch(`/admin/broadcasts/api/${id}/launch/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
        const data = await res.json();
        
        if (data.success) {
            showAlert('üöÄ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error || '–û—à–∏–±–∫–∞', 'error');
        }
    } catch (err) {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    }
}

async function deleteBroadcast(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?')) return;
    
    try {
        const res = await fetch(`/admin/broadcasts/api/${id}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
        const data = await res.json();
        
        if (data.success) {
            showAlert('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ');
            document.getElementById(`broadcast-${id}`).remove();
        } else {
            showAlert(data.error || '–û—à–∏–±–∫–∞', 'error');
        }
    } catch (err) {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    }
}

// Image upload functions
function handleImageSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –†–∞–∑—Ä–µ—à–µ–Ω—ã: JPG, PNG, GIF, WebP', 'error');
        return;
    }
    
    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
        showAlert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 10 –ú–ë', 'error');
        return;
    }
    
    uploadImage(file);
}

async function uploadImage(file) {
    const uploadArea = document.getElementById('upload-area');
    const placeholder = document.getElementById('upload-placeholder');
    const preview = document.getElementById('image-preview');
    
    placeholder.innerHTML = '<div style="font-size: 24px;">‚è≥</div><div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    const formData = new FormData();
    formData.append('image', file);
    
    try {
        const res = await fetch('/admin/broadcasts/api/upload-image/', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('photo-url-input').value = data.url;
            document.getElementById('preview-img').src = data.url;
            placeholder.style.display = 'none';
            preview.style.display = 'block';
            showAlert('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
        } else {
            placeholder.innerHTML = '<div style="font-size: 32px; margin-bottom: 8px;">üì∑</div><div>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div><div class="form-hint">JPG, PNG, GIF, WebP –¥–æ 10 –ú–ë</div>';
            showAlert(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
        }
    } catch (err) {
        placeholder.innerHTML = '<div style="font-size: 32px; margin-bottom: 8px;">üì∑</div><div>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div><div class="form-hint">JPG, PNG, GIF, WebP –¥–æ 10 –ú–ë</div>';
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    }
}

function removeImage() {
    document.getElementById('photo-url-input').value = '';
    document.getElementById('file-input').value = '';
    document.getElementById('preview-img').src = '';
    document.getElementById('upload-placeholder').style.display = 'block';
    document.getElementById('upload-placeholder').innerHTML = '<div style="font-size: 32px; margin-bottom: 8px;">üì∑</div><div>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div><div class="form-hint">JPG, PNG, GIF, WebP –¥–æ 10 –ú–ë</div>';
    document.getElementById('image-preview').style.display = 'none';
}

// Drag and drop support
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                document.getElementById('file-input').files = e.dataTransfer.files;
                handleImageSelect({ target: { files: [file] } });
            }
        });
    }
});

// Auto-refresh for sending
setInterval(() => {
    if (document.querySelector('.status-sending')) {
        location.reload();
    }
}, 10000);
</script>
{% endblock %}

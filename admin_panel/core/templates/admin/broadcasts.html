{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}–†–∞—Å—Å—ã–ª–∫–∏ | {{ site_title }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .broadcasts-container {
        padding: 0;
    }
    
    /* –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ */
    .back-btn:hover {
        background: var(--color-bg-secondary, #f3f4f6) !important;
        transform: translateX(-2px);
    }
    
    /* –°–µ–∫—Ü–∏–∏ */
    .broadcasts-section {
        margin-bottom: 32px;
    }
    
    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--color-text-primary, #1f2937);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* KPI –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }
    
    .kpi-card {
        background: var(--color-bg-primary, #fff);
        border-radius: 12px;
        padding: 20px 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    
    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }
    
    .kpi-card.primary::before { background: linear-gradient(90deg, #8B5CF6, #A78BFA); }
    .kpi-card.success::before { background: linear-gradient(90deg, #10B981, #34D399); }
    .kpi-card.warning::before { background: linear-gradient(90deg, #F59E0B, #FBBF24); }
    .kpi-card.danger::before { background: linear-gradient(90deg, #EF4444, #F87171); }
    
    .kpi-label {
        font-size: 13px;
        color: var(--color-text-secondary, #6b7280);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    
    .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--color-text-primary, #1f2937);
        line-height: 1.2;
    }
    
    /* –ö–æ–Ω—Ç–µ–Ω—Ç –≥—Ä–∏–¥ */
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 24px;
    }
    
    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
    .card {
        background: var(--color-bg-primary, #fff);
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .card-header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--color-border, #e5e7eb);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--color-text-primary, #1f2937);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .card-badge {
        background: #8B5CF6;
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .card-body {
        padding: 24px;
    }
    
    /* –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Å—ã–ª–æ–∫ - Grid 3 –∫–æ–ª–æ–Ω–∫–∏ */
    .broadcast-list {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        padding: 16px;
    }
    
    @media (max-width: 1400px) {
        .broadcast-list {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 900px) {
        .broadcast-list {
            grid-template-columns: 1fr;
        }
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ */
    .broadcast-card {
        background: var(--color-bg-primary, #fff);
        border-radius: 12px;
        border: 1px solid var(--color-border, #e5e7eb);
        overflow: hidden;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
    }
    
    .broadcast-card:hover {
        border-color: #8B5CF6;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
    }
    
    /* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ */
    .card-image {
        position: relative;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .card-image img {
        width: 100%;
        height: auto;
        max-height: 200px;
        object-fit: contain;
        display: block;
        background: #000;
    }
    
    .card-image-placeholder {
        width: 100%;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        opacity: 0.6;
    }
    
    .card-status {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-draft { background: rgba(107, 114, 128, 0.9); color: white; }
    .status-scheduled { background: rgba(37, 99, 235, 0.9); color: white; }
    .status-sending { background: rgba(217, 119, 6, 0.9); color: white; }
    .status-sent { background: rgba(5, 150, 105, 0.9); color: white; }
    .status-failed { background: rgba(220, 38, 38, 0.9); color: white; }
    
    /* –ö–æ–Ω—Ç–µ–Ω—Ç */
    .card-body {
        padding: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .card-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--color-text-primary, #1f2937);
        margin: 0 0 6px 0;
        line-height: 1.3;
    }
    
    .card-text {
        font-size: 12px;
        color: var(--color-text-secondary, #6b7280);
        line-height: 1.5;
        margin-bottom: 8px;
        flex: 1;
    }
    
    .card-text.collapsed {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .card-text.expanded {
        display: block;
    }
    
    .read-more-btn {
        background: none;
        border: none;
        color: #8B5CF6;
        font-size: 11px;
        cursor: pointer;
        padding: 0;
        margin-bottom: 8px;
        font-weight: 500;
        display: none;
    }
    
    .read-more-btn.visible {
        display: inline-block;
    }
    
    .read-more-btn:hover {
        text-decoration: underline;
    }
    
    /* –ú–µ—Ç–∞ */
    .card-meta {
        display: flex;
        gap: 8px;
        font-size: 11px;
        color: var(--color-text-secondary, #9ca3af);
        margin-bottom: 8px;
    }
    
    /* –ü—Ä–æ–≥—Ä–µ—Å—Å */
    .card-progress {
        margin-bottom: 8px;
    }
    
    .progress-bar-sm {
        height: 3px;
        background: var(--color-border, #e5e7eb);
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 2px;
    }
    
    .progress-fill-sm {
        height: 100%;
        background: #10B981;
    }
    
    .progress-label {
        font-size: 10px;
        color: var(--color-text-secondary, #9ca3af);
    }
    
    /* –§—É—Ç–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--color-bg-secondary, #f9fafb);
        border-top: 1px solid var(--color-border, #e5e7eb);
    }
    
    .card-actions {
        display: flex;
        gap: 4px;
    }
    
    .btn-icon {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        color: var(--color-text-secondary, #6b7280);
    }
    
    .btn-icon:hover {
        background: var(--color-bg-primary, #fff);
    }
    
    .btn-icon.launch:hover {
        background: #D1FAE5;
        color: #059669;
    }
    
    .btn-icon.edit:hover {
        background: #DBEAFE;
        color: #2563EB;
    }
    
    .btn-icon.delete:hover {
        background: #FEE2E2;
        color: #DC2626;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
    }
    
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal {
        background: var(--color-bg-primary, #fff);
        border-radius: 16px;
        width: 100%;
        max-width: 560px;
        max-height: 90vh;
        overflow: hidden;
        transform: scale(0.9) translateY(20px);
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
    }
    
    .modal-overlay.active .modal {
        transform: scale(1) translateY(0);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--color-border, #e5e7eb);
    }
    
    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--color-text-primary, #1f2937);
        margin: 0;
    }
    
    .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--color-bg-secondary, #f3f4f6);
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
        color: var(--color-text-secondary, #6b7280);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-close:hover {
        background: #FEE2E2;
        color: #DC2626;
    }
    
    .modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }
    
    .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--color-border, #e5e7eb);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }
    
    /* –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è */
    .btn-create-new {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
        color: white;
        border: none;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 100;
    }
    
    .btn-create-new:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 24px rgba(139, 92, 246, 0.5);
    }
    
    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        text-decoration: none;
    }
    
    .btn-launch {
        background: #10B981;
        color: white;
    }
    
    .btn-launch:hover {
        background: #059669;
        transform: translateY(-1px);
    }
    
    .btn-delete {
        background: #FEE2E2;
        color: #DC2626;
    }
    
    .btn-delete:hover {
        background: #FECACA;
    }
    
    .btn-create {
        width: 100%;
        padding: 14px 20px;
        background: linear-gradient(90deg, #8B5CF6, #A78BFA);
        color: white;
        font-size: 15px;
    }
    
    .btn-create:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    
    /* –ü—Ä–æ–≥—Ä–µ—Å—Å */
    .progress-bar {
        height: 6px;
        background: var(--color-border, #e5e7eb);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 6px;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10B981, #34D399);
        transition: width 0.3s;
    }
    
    .progress-text {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--color-text-secondary, #6b7280);
    }
    
    /* –ú–∏–Ω–∏–∞—Ç—é—Ä–∞ */
    .broadcast-thumbnail {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        margin-right: 12px;
        flex-shrink: 0;
    }
    
    .broadcast-content {
        flex: 1;
        min-width: 0;
    }
    
    .broadcast-row {
        display: flex;
        align-items: flex-start;
    }
    
    /* Image Upload */
    .image-upload-area {
        border: 2px dashed var(--color-border, #e5e7eb);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    
    .image-upload-area:hover,
    .image-upload-area.dragover {
        border-color: #8B5CF6;
        background: rgba(139, 92, 246, 0.05);
    }
    
    .image-preview {
        position: relative;
        display: inline-block;
    }
    
    .image-preview img {
        max-width: 100%;
        max-height: 150px;
        border-radius: 6px;
    }
    
    .remove-image {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: #DC2626;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }
    
    .remove-image:hover {
        background: #B91C1C;
    }
    
    .remove-image {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: #EF4444;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        display: none;
    }
    
    .image-upload-area.has-image .remove-image {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .image-upload-area.has-image .upload-placeholder {
        display: none;
    }
    
    /* –§–æ—Ä–º–∞ */
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-label {
        display: block;
        font-size: 13px;
        color: var(--color-text-secondary, #6b7280);
        margin-bottom: 6px;
        font-weight: 500;
    }
    
    .form-input,
    .form-textarea,
    .form-select {
        width: 100%;
        padding: 10px 14px;
        background: var(--color-bg-primary, #fff);
        border: 1px solid var(--color-border, #e5e7eb);
        border-radius: 8px;
        color: var(--color-text-primary, #1f2937);
        font-size: 14px;
        transition: border-color 0.2s;
        box-sizing: border-box;
    }
    
    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
        outline: none;
        border-color: #8B5CF6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .form-textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
    }
    
    /* Rich Text Editor */
    .editor-container {
        border: 1px solid var(--color-border, #e5e7eb);
        border-radius: 8px;
        overflow: hidden;
        background: var(--color-bg-primary, #fff);
    }
    
    .editor-toolbar {
        display: flex;
        gap: 4px;
        padding: 8px 12px;
        background: var(--color-bg-secondary, #f9fafb);
        border-bottom: 1px solid var(--color-border, #e5e7eb);
        flex-wrap: wrap;
    }
    
    .editor-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: var(--color-text-secondary, #6b7280);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
    }
    
    .editor-btn:hover {
        background: var(--color-bg-primary, #fff);
        color: var(--color-text-primary, #1f2937);
    }
    
    .editor-btn.active {
        background: #8B5CF6;
        color: white;
    }
    
    .editor-btn-bold { font-weight: 700; }
    .editor-btn-italic { font-style: italic; }
    .editor-btn-strike { text-decoration: line-through; }
    .editor-btn-code { font-family: monospace; font-size: 13px; }
    
    .editor-divider {
        width: 1px;
        background: var(--color-border, #e5e7eb);
        margin: 4px 6px;
    }
    
    .editor-content {
        min-height: 120px;
        padding: 12px 14px;
        outline: none;
        font-size: 14px;
        line-height: 1.6;
        color: var(--color-text-primary, #1f2937);
    }
    
    .editor-content:focus {
        box-shadow: inset 0 0 0 2px rgba(139, 92, 246, 0.2);
    }
    
    .editor-content:empty::before {
        content: attr(data-placeholder);
        color: var(--color-text-secondary, #9ca3af);
        pointer-events: none;
    }
    
    .editor-content b, .editor-content strong { font-weight: 600; }
    .editor-content i, .editor-content em { font-style: italic; }
    .editor-content s { text-decoration: line-through; }
    .editor-content code {
        background: #f3f4f6;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 13px;
    }
    .editor-content a {
        color: #8B5CF6;
        text-decoration: underline;
    }
    
    .form-hint {
        font-size: 12px;
        color: var(--color-text-secondary, #9ca3af);
        margin-top: 4px;
    }
    
    /* Empty State */
    .empty-state {
        padding: 48px 24px;
        text-align: center;
    }
    
    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }
    
    .empty-text {
        color: var(--color-text-secondary, #6b7280);
        font-size: 14px;
    }
    
    /* Alerts */
    .alerts-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .alert {
        padding: 12px 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease;
        min-width: 280px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .alert-success {
        background: #D1FAE5;
        color: #065F46;
    }
    
    .alert-error {
        background: #FEE2E2;
        color: #991B1B;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .kpi-grid { grid-template-columns: repeat(2, 1fr); }
        .content-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="broadcasts-container">
    
    <!-- –®–∞–ø–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π –Ω–∞–∑–∞–¥ -->
    <div class="broadcasts-header" style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
        <a href="/admin/" class="back-btn" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: var(--color-bg-primary, #fff); border-radius: 10px; text-decoration: none; color: var(--color-text-primary, #374151); font-weight: 500; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s;">
            <span style="font-size: 18px;">‚Üê</span> –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É
        </a>
        <h1 style="margin: 0; font-size: 24px; font-weight: 700; color: var(--color-text-primary, #1f2937);">üì¢ –†–∞—Å—Å—ã–ª–∫–∏</h1>
        <button onclick="location.reload()" style="margin-left: auto; padding: 10px 16px; background: var(--color-bg-primary, #fff); border: 1px solid var(--color-border, #e5e7eb); border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--color-text-primary, #374151);">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    
    <!-- Alerts Container -->
    <div class="alerts-container" id="alerts"></div>
    
    <!-- KPI -->
    <section class="broadcasts-section">
        <h2 class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="kpi-grid">
            <div class="kpi-card primary">
                <div class="kpi-label">–í—Å–µ–≥–æ —Ä–∞—Å—Å—ã–ª–æ–∫</div>
                <div class="kpi-value">{{ stats.total }}</div>
            </div>
            <div class="kpi-card success">
                <div class="kpi-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                <div class="kpi-value">{{ stats.total_sent }}</div>
            </div>
            <div class="kpi-card warning">
                <div class="kpi-label">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                <div class="kpi-value">{{ stats.in_progress }}</div>
            </div>
            <div class="kpi-card danger">
                <div class="kpi-label">–û—à–∏–±–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏</div>
                <div class="kpi-value">{{ stats.total_failed }}</div>
            </div>
        </div>
    </section>
    
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <section class="broadcasts-section">
        <!-- –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Å—ã–ª–æ–∫ -->
        <div class="card" style="width: 100%;">
            <div class="card-header">
                <span class="card-title">üìã –†–∞—Å—Å—ã–ª–∫–∏</span>
                <span class="card-badge">{{ broadcasts|length }}</span>
            </div>
            <div class="broadcast-list">
                {% if broadcasts %}
                    {% for b in broadcasts %}
                    <div class="broadcast-card" id="broadcast-{{ b.id }}">
                        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                        <div class="card-image">
                            {% if b.message_photo_url %}
                            <img src="{{ b.message_photo_url }}" alt="">
                            {% else %}
                            <div class="card-image-placeholder">üì¢</div>
                            {% endif %}
                            <span class="card-status status-{{ b.status }}">
                                {% if b.status == 'draft' %}—á–µ—Ä–Ω–æ–≤–∏–∫
                                {% elif b.status == 'scheduled' %}–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞
                                {% elif b.status == 'sending' %}–æ—Ç–ø—Ä–∞–≤–∫–∞
                                {% elif b.status == 'sent' %}–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
                                {% else %}–æ—à–∏–±–∫–∞{% endif %}
                            </span>
                        </div>
                        
                        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
                        <div class="card-body">
                            <h4 class="card-title">{{ b.title }}</h4>
                            <div class="card-text collapsed" id="text-{{ b.id }}">{{ b.message_text|safe }}</div>
                            <button class="read-more-btn" id="btn-{{ b.id }}" onclick="toggleText('{{ b.id }}')">–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ</button>
                            
                            <div class="card-meta">
                                <span>üë• {{ b.get_target_audience_display }}</span>
                                <span>üìÖ {{ b.date_created|date:"d.m.Y" }}</span>
                            </div>
                            
                            {% if b.total_recipients %}
                            <div class="card-progress">
                                <div class="progress-bar-sm">
                                    <div class="progress-fill-sm" style="width: {% widthratio b.sent_count b.total_recipients 100 %}%"></div>
                                </div>
                                <div class="progress-label">{{ b.sent_count }}/{{ b.total_recipients }} ‚Ä¢ {{ b.failed_count }} –æ—à–∏–±–æ–∫</div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- –§—É—Ç–µ—Ä -->
                        <div class="card-footer">
                            <div class="card-actions">
                                {% if b.status == 'draft' or b.status == 'scheduled' or b.status == 'failed' %}
                                <button class="btn-icon edit" onclick="editBroadcast('{{ b.id }}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                                <button class="btn-icon launch" onclick="launchBroadcast('{{ b.id }}')" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å">üöÄ</button>
                                {% endif %}
                            </div>
                            {% if b.status != 'sending' %}
                            <button class="btn-icon delete" onclick="deleteBroadcast('{{ b.id }}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-text">–ù–µ—Ç —Ä–∞—Å—Å—ã–ª–æ–∫. –ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å!</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </section>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
<button class="btn-create-new" onclick="openModal()" title="–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É">+</button>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">‚ú® –ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="create-form" onsubmit="saveBroadcast(event)">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                    <input type="text" name="title" class="form-input" placeholder="–ù–æ–≤–æ–≥–æ–¥–Ω—è—è –∞–∫—Ü–∏—è" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è *</label>
                    <input type="hidden" name="message_text" id="message-text-input">
                    <div class="editor-container">
                        <div class="editor-toolbar">
                            <button type="button" class="editor-btn editor-btn-bold" onclick="formatText('bold')" title="–ñ–∏—Ä–Ω—ã–π (Ctrl+B)">B</button>
                            <button type="button" class="editor-btn editor-btn-italic" onclick="formatText('italic')" title="–ö—É—Ä—Å–∏–≤ (Ctrl+I)">I</button>
                            <button type="button" class="editor-btn editor-btn-strike" onclick="formatText('strikeThrough')" title="–ó–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π">S</button>
                            <button type="button" class="editor-btn editor-btn-code" onclick="formatText('code')" title="–ö–æ–¥">&lt;/&gt;</button>
                            <div class="editor-divider"></div>
                            <button type="button" class="editor-btn" onclick="insertLink()" title="–°—Å—ã–ª–∫–∞">üîó</button>
                        </div>
                        <div class="editor-content" 
                             id="message-editor" 
                             contenteditable="true" 
                             data-placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏..."></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                    <input type="hidden" name="message_photo_url" id="photo-url-input">
                    <div class="image-upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                        <div id="upload-placeholder">
                            <div style="font-size: 24px; margin-bottom: 4px;">üì∑</div>
                            <div style="font-size: 13px;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                        </div>
                        <div id="image-preview" class="image-preview" style="display: none;">
                            <img id="preview-img" src="" alt="Preview">
                            <button type="button" class="remove-image" onclick="event.stopPropagation(); removeImage()">√ó</button>
                        </div>
                    </div>
                    <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
                    <select name="target_audience" class="form-select">
                        <option value="all">üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                        <option value="premium">‚≠ê Premium</option>
                        <option value="free">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</label>
                    <input type="datetime-local" name="scheduled_at" class="form-input">
                </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn" style="background: #f3f4f6; color: #374151;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn btn-create" id="submit-btn" form="create-form">‚ú® –°–æ–∑–¥–∞—Ç—å</button>
            </form>
        </div>
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';

// ============================================================================
// MODAL
// ============================================================================

function openModal() {
    document.getElementById('modal-overlay').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('modal-overlay').classList.remove('active');
    document.body.style.overflow = '';
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    if (typeof resetForm === 'function') resetForm();
}

// Close on Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
});

// ============================================================================
// TEXT EXPAND
// ============================================================================

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.card-text.collapsed').forEach(function(el) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–±—Ä–µ–∑–∞–Ω –ª–∏ —Ç–µ–∫—Å—Ç
        if (el.scrollHeight > el.clientHeight) {
            const id = el.id.replace('text-', '');
            const btn = document.getElementById('btn-' + id);
            if (btn) btn.classList.add('visible');
        }
    });
});

function toggleText(id) {
    const text = document.getElementById('text-' + id);
    const btn = document.getElementById('btn-' + id);
    
    if (text.classList.contains('collapsed')) {
        text.classList.remove('collapsed');
        text.classList.add('expanded');
        btn.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
    } else {
        text.classList.remove('expanded');
        text.classList.add('collapsed');
        btn.textContent = '–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ';
    }
}

// ============================================================================
// RICH TEXT EDITOR
// ============================================================================

function formatText(command) {
    const editor = document.getElementById('message-editor');
    editor.focus();
    
    if (command === 'code') {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const selectedText = range.toString();
            
            if (selectedText) {
                const parentCode = selection.anchorNode.parentElement.closest('code');
                if (parentCode) {
                    const text = document.createTextNode(parentCode.textContent);
                    parentCode.parentNode.replaceChild(text, parentCode);
                } else {
                    const code = document.createElement('code');
                    range.surroundContents(code);
                }
            }
        }
    } else {
        document.execCommand(command, false, null);
    }
}

function insertLink() {
    const url = prompt('–í–≤–µ–¥–∏—Ç–µ URL —Å—Å—ã–ª–∫–∏:', 'https://');
    if (url && url !== 'https://') {
        const selection = window.getSelection();
        const selectedText = selection.toString() || '—Å—Å—ã–ª–∫–∞';
        
        document.execCommand('insertHTML', false, `<a href="${url}">${selectedText}</a>`);
    }
}

function insertEmoji(emoji) {
    const editor = document.getElementById('message-editor');
    editor.focus();
    document.execCommand('insertText', false, emoji);
}

function getEditorHTML() {
    const editor = document.getElementById('message-editor');
    let html = editor.innerHTML;
    
    // –û—á–∏—â–∞–µ–º HTML –æ—Ç –ª–∏—à–Ω–∏—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –±—Ä–∞—É–∑–µ—Ä–∞
    html = html.replace(/<div>/gi, '\n');
    html = html.replace(/<\/div>/gi, '');
    html = html.replace(/<br\s*\/?>/gi, '\n');
    html = html.replace(/&nbsp;/gi, ' ');
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º strong/em –≤ b/i –¥–ª—è Telegram
    html = html.replace(/<strong>/gi, '<b>');
    html = html.replace(/<\/strong>/gi, '</b>');
    html = html.replace(/<em>/gi, '<i>');
    html = html.replace(/<\/em>/gi, '</i>');
    html = html.replace(/<strike>/gi, '<s>');
    html = html.replace(/<\/strike>/gi, '</s>');
    
    // –£–±–∏—Ä–∞–µ–º span –∏ –¥—Ä—É–≥–∏–µ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–µ–≥–∏, –æ—Å—Ç–∞–≤–ª—è—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    html = html.replace(/<span[^>]*>/gi, '');
    html = html.replace(/<\/span>/gi, '');
    html = html.replace(/<font[^>]*>/gi, '');
    html = html.replace(/<\/font>/gi, '');
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    html = html.replace(/\n\n+/g, '\n\n');
    html = html.trim();
    
    return html;
}

function clearEditor() {
    document.getElementById('message-editor').innerHTML = '';
}

// Keyboard shortcuts
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('message-editor');
    if (editor) {
        editor.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'b') {
                    e.preventDefault();
                    formatText('bold');
                } else if (e.key === 'i') {
                    e.preventDefault();
                    formatText('italic');
                }
            }
        });
    }
});

// ============================================================================
// ALERTS & FORMS
// ============================================================================

function showAlert(message, type = 'success') {
    const container = document.getElementById('alerts');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    container.appendChild(alert);
    setTimeout(() => alert.remove(), 4000);
}

async function launchBroadcast(id) {
    if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?')) return;
    
    try {
        const res = await fetch(`/admin/broadcasts/api/${id}/launch/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
        const data = await res.json();
        
        if (data.success) {
            showAlert('üöÄ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error || '–û—à–∏–±–∫–∞', 'error');
        }
    } catch (err) {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    }
}

async function deleteBroadcast(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?')) return;
    
    try {
        const res = await fetch(`/admin/broadcasts/api/${id}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        });
        const data = await res.json();
        
        if (data.success) {
            showAlert('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ');
            document.getElementById(`broadcast-${id}`).remove();
        } else {
            showAlert(data.error || '–û—à–∏–±–∫–∞', 'error');
        }
    } catch (err) {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    }
}

// ============================================================================
// EDIT BROADCAST
// ============================================================================

let editingBroadcastId = null;

async function editBroadcast(id) {
    try {
        const res = await fetch(`/admin/broadcasts/api/${id}/get/`);
        const data = await res.json();
        
        if (!data.success) {
            showAlert(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
            return;
        }
        
        const b = data.broadcast;
        editingBroadcastId = id;
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
        const form = document.getElementById('create-form');
        form.querySelector('[name="title"]').value = b.title;
        document.getElementById('message-editor').innerHTML = b.message_text;
        form.querySelector('[name="target_audience"]').value = b.target_audience;
        
        // –î–∞—Ç–∞
        if (b.scheduled_at) {
            const dt = new Date(b.scheduled_at);
            const localDt = new Date(dt.getTime() - dt.getTimezoneOffset() * 60000);
            form.querySelector('[name="scheduled_at"]').value = localDt.toISOString().slice(0, 16);
        } else {
            form.querySelector('[name="scheduled_at"]').value = '';
        }
        
        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (b.message_photo_url) {
            document.getElementById('photo-url-input').value = b.message_photo_url;
            document.getElementById('preview-img').src = b.message_photo_url;
            document.getElementById('upload-placeholder').style.display = 'none';
            document.getElementById('image-preview').style.display = 'block';
        } else {
            removeImage();
        }
        
        // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        document.getElementById('submit-btn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        document.querySelector('.modal-title').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
        
        openModal();
    } catch (err) {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    }
}

async function saveBroadcast(e) {
    e.preventDefault();
    const form = document.getElementById('create-form');
    const btn = document.getElementById('submit-btn');
    
    const messageText = getEditorHTML();
    if (!messageText.trim()) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
        return;
    }
    
    document.getElementById('message-text-input').value = messageText;
    const formData = new FormData(form);
    
    btn.disabled = true;
    btn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    
    const url = editingBroadcastId 
        ? `/admin/broadcasts/api/${editingBroadcastId}/update/`
        : '/admin/broadcasts/api/create/';
    
    try {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });
        const data = await res.json();
        
        if (data.success) {
            showAlert(editingBroadcastId ? 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!' : '‚úÖ –°–æ–∑–¥–∞–Ω–æ!');
            resetForm();
            closeModal();
            setTimeout(() => location.reload(), 800);
        } else {
            showAlert(data.error || '–û—à–∏–±–∫–∞', 'error');
        }
    } catch (err) {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = editingBroadcastId ? 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '‚ú® –°–æ–∑–¥–∞—Ç—å';
    }
}

function resetForm() {
    const form = document.getElementById('create-form');
    form.reset();
    clearEditor();
    removeImage();
    editingBroadcastId = null;
    document.getElementById('submit-btn').textContent = '‚ú® –°–æ–∑–¥–∞—Ç—å';
    document.querySelector('.modal-title').textContent = '‚ú® –ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞';
}

// Image upload functions
function handleImageSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –†–∞–∑—Ä–µ—à–µ–Ω—ã: JPG, PNG, GIF, WebP', 'error');
        return;
    }
    
    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
        showAlert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 10 –ú–ë', 'error');
        return;
    }
    
    uploadImage(file);
}

async function uploadImage(file) {
    const uploadArea = document.getElementById('upload-area');
    const placeholder = document.getElementById('upload-placeholder');
    const preview = document.getElementById('image-preview');
    
    placeholder.innerHTML = '<div style="font-size: 24px;">‚è≥</div><div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    const formData = new FormData();
    formData.append('image', file);
    
    try {
        const res = await fetch('/admin/broadcasts/api/upload-image/', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('photo-url-input').value = data.url;
            document.getElementById('preview-img').src = data.url;
            placeholder.style.display = 'none';
            preview.style.display = 'block';
            showAlert('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
        } else {
            placeholder.innerHTML = '<div style="font-size: 32px; margin-bottom: 8px;">üì∑</div><div>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div><div class="form-hint">JPG, PNG, GIF, WebP –¥–æ 10 –ú–ë</div>';
            showAlert(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
        }
    } catch (err) {
        placeholder.innerHTML = '<div style="font-size: 32px; margin-bottom: 8px;">üì∑</div><div>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div><div class="form-hint">JPG, PNG, GIF, WebP –¥–æ 10 –ú–ë</div>';
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    }
}

function removeImage() {
    document.getElementById('photo-url-input').value = '';
    document.getElementById('file-input').value = '';
    document.getElementById('preview-img').src = '';
    document.getElementById('upload-placeholder').style.display = 'block';
    document.getElementById('upload-placeholder').innerHTML = '<div style="font-size: 32px; margin-bottom: 8px;">üì∑</div><div>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div><div class="form-hint">JPG, PNG, GIF, WebP –¥–æ 10 –ú–ë</div>';
    document.getElementById('image-preview').style.display = 'none';
}

// Drag and drop support
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                document.getElementById('file-input').files = e.dataTransfer.files;
                handleImageSelect({ target: { files: [file] } });
            }
        });
    }
});

// Auto-refresh for sending
setInterval(() => {
    if (document.querySelector('.status-sending')) {
        location.reload();
    }
}, 10000);
</script>
{% endblock %}

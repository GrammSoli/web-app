{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | {{ site_title }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .dashboard-container {
        padding: 0;
    }
    
    /* –§–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ */
    .period-filter {
        background: var(--color-bg-primary, #fff);
        border-radius: 12px;
        padding: 16px 24px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .period-filter label {
        font-weight: 600;
        color: var(--color-text-primary, #1f2937);
    }
    
    .period-btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid var(--color-border, #e5e7eb);
        background: var(--color-bg-primary, #fff);
        color: var(--color-text-primary, #374151);
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .period-btn:hover {
        background: var(--color-bg-secondary, #f3f4f6);
    }
    
    .period-btn.active {
        background: #8B5CF6;
        color: white;
        border-color: #8B5CF6;
    }
    
    .date-inputs {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .date-inputs input {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--color-border, #e5e7eb);
        font-size: 14px;
    }
    
    /* –°–µ–∫—Ü–∏–∏ */
    .dashboard-section {
        margin-bottom: 32px;
    }
    
    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--color-text-primary, #1f2937);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* KPI –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
    }
    
    .kpi-card {
        background: var(--color-bg-primary, #fff);
        border-radius: 12px;
        padding: 20px 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    
    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }
    
    .kpi-card.pulse::before { background: linear-gradient(90deg, #10B981, #34D399); }
    .kpi-card.money::before { background: linear-gradient(90deg, #F59E0B, #FBBF24); }
    .kpi-card.retention::before { background: linear-gradient(90deg, #8B5CF6, #A78BFA); }
    .kpi-card.danger::before { background: linear-gradient(90deg, #EF4444, #F87171); }
    
    .kpi-label {
        font-size: 13px;
        color: var(--color-text-secondary, #6b7280);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    
    .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--color-text-primary, #1f2937);
        line-height: 1.2;
    }
    
    .kpi-change {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        font-weight: 600;
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 6px;
    }
    
    .kpi-change.positive {
        color: #059669;
        background: #D1FAE5;
    }
    
    .kpi-change.negative {
        color: #DC2626;
        background: #FEE2E2;
    }
    
    .kpi-change.neutral {
        color: #6B7280;
        background: #F3F4F6;
    }
    
    .kpi-subtitle {
        font-size: 12px;
        color: var(--color-text-secondary, #9ca3af);
        margin-top: 4px;
    }
    
    /* –ì—Ä–∞—Ñ–∏–∫–∏ */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
    }
    
    .chart-card {
        background: var(--color-bg-primary, #fff);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .chart-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--color-text-primary, #1f2937);
        margin-bottom: 16px;
    }
    
    .chart-container {
        position: relative;
        height: 250px;
    }
    
    /* –¢–∞–±–ª–∏—Ü—ã */
    .tables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
    }
    
    .table-card {
        background: var(--color-bg-primary, #fff);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .table-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--color-text-primary, #1f2937);
        margin-bottom: 16px;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--color-border, #e5e7eb);
        font-size: 14px;
    }
    
    .data-table th {
        font-weight: 600;
        color: var(--color-text-secondary, #6b7280);
        font-size: 12px;
        text-transform: uppercase;
    }
    
    .data-table tr:last-child td {
        border-bottom: none;
    }
    
    .data-table tr:hover td {
        background: var(--color-bg-secondary, #f9fafb);
    }
    
    .amount-positive {
        color: #059669;
        font-weight: 600;
    }
    
    .amount-negative {
        color: #DC2626;
        font-weight: 600;
    }
    
    /* Retention bars */
    .retention-bar {
        height: 8px;
        background: #E5E7EB;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
    }
    
    .retention-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    
    .retention-bar-fill.good { background: linear-gradient(90deg, #10B981, #34D399); }
    .retention-bar-fill.warning { background: linear-gradient(90deg, #F59E0B, #FBBF24); }
    .retention-bar-fill.bad { background: linear-gradient(90deg, #EF4444, #F87171); }
    
    /* Responsive */
    @media (max-width: 768px) {
        .kpi-grid { grid-template-columns: 1fr; }
        .charts-grid { grid-template-columns: 1fr; }
        .tables-grid { grid-template-columns: 1fr; }
        .period-filter { flex-direction: column; align-items: stretch; }
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        .kpi-card, .chart-card, .table-card, .period-filter {
            background: #1f2937;
        }
        .kpi-value, .section-title, .chart-title, .table-title {
            color: #f9fafb;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <!-- –§–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
    <div class="period-filter">
        <label>üìÖ –ü–µ—Ä–∏–æ–¥:</label>
        <button class="period-btn {% if current_period == 'today' %}active{% endif %}" 
                onclick="setPeriod('today')">–°–µ–≥–æ–¥–Ω—è</button>
        <button class="period-btn {% if current_period == 'yesterday' %}active{% endif %}" 
                onclick="setPeriod('yesterday')">–í—á–µ—Ä–∞</button>
        <button class="period-btn {% if current_period == 'week' %}active{% endif %}" 
                onclick="setPeriod('week')">–ù–µ–¥–µ–ª—è</button>
        <button class="period-btn {% if current_period == 'month' %}active{% endif %}" 
                onclick="setPeriod('month')">–ú–µ—Å—è—Ü</button>
        
        <div class="date-inputs">
            <input type="date" id="start_date" value="{{ start_date }}">
            <span>‚Äî</span>
            <input type="date" id="end_date" value="{{ end_date }}">
            <button class="period-btn" onclick="setCustomPeriod()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <!-- –ë–õ–û–ö 1: –ü–£–õ–¨–° -->
    <div class="dashboard-section">
        <h2 class="section-title">üíì –ü—É–ª—å—Å (–ñ–∏–≤ –ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç?)</h2>
        <div class="kpi-grid">
            <div class="kpi-card pulse">
                <div class="kpi-label">DAU (–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)</div>
                <div class="kpi-value">{{ dashboard.pulse.dau.value }}</div>
                <div class="kpi-change {% if dashboard.pulse.dau.change >= 0 %}positive{% else %}negative{% endif %}">
                    {% if dashboard.pulse.dau.change >= 0 %}‚Üë{% else %}‚Üì{% endif %} 
                    {{ dashboard.pulse.dau.change }}%
                </div>
                <div class="kpi-subtitle">–ë—ã–ª–æ: {{ dashboard.pulse.dau.prev }}</div>
            </div>
            
            <div class="kpi-card pulse">
                <div class="kpi-label">–ó–∞–ø–∏—Å–µ–π</div>
                <div class="kpi-value">{{ dashboard.pulse.entries.value }}</div>
                <div class="kpi-change {% if dashboard.pulse.entries.change >= 0 %}positive{% else %}negative{% endif %}">
                    {% if dashboard.pulse.entries.change >= 0 %}‚Üë{% else %}‚Üì{% endif %} 
                    {{ dashboard.pulse.entries.change }}%
                </div>
                <div class="kpi-subtitle">üé§ –ì–æ–ª–æ—Å–æ–≤—ã—Ö: {{ dashboard.pulse.entries.voice }}</div>
            </div>
            
            <div class="kpi-card pulse">
                <div class="kpi-label">–ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                <div class="kpi-value">{{ dashboard.pulse.signups.value }}</div>
                <div class="kpi-change {% if dashboard.pulse.signups.change >= 0 %}positive{% else %}negative{% endif %}">
                    {% if dashboard.pulse.signups.change >= 0 %}‚Üë{% else %}‚Üì{% endif %} 
                    {{ dashboard.pulse.signups.change }}%
                </div>
                <div class="kpi-subtitle">–ë—ã–ª–æ: {{ dashboard.pulse.signups.prev }}</div>
            </div>
            
            <div class="kpi-card pulse">
                <div class="kpi-label">–ó–∞–ø–∏—Å–µ–π –Ω–∞ —é–∑–µ—Ä–∞</div>
                <div class="kpi-value">{{ dashboard.pulse.entries_per_user }}</div>
                <div class="kpi-subtitle">–°—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            </div>
        </div>
    </div>
    
    <!-- –ë–õ–û–ö 2: –î–ï–ù–¨–ì–ò -->
    <div class="dashboard-section">
        <h2 class="section-title">üí∏ –î–µ–Ω—å–≥–∏ (–•–≤–∞—Ç–∞–µ—Ç –ª–∏ –Ω–∞ –µ–¥—É?)</h2>
        <div class="kpi-grid">
            <div class="kpi-card money">
                <div class="kpi-label">MRR (–ú–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥)</div>
                <div class="kpi-value">${{ dashboard.money.mrr.usd|floatformat:2 }}</div>
                <div class="kpi-subtitle">‚≠ê {{ dashboard.money.mrr.stars }} –∑–≤—ë–∑–¥ ‚Ä¢ {{ dashboard.money.mrr.subscribers }} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
            </div>
            
            <div class="kpi-card money">
                <div class="kpi-label">–î–æ—Ö–æ–¥ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
                <div class="kpi-value">${{ dashboard.money.revenue.usd|floatformat:2 }}</div>
                <div class="kpi-subtitle">‚≠ê {{ dashboard.money.revenue.stars }} ‚Ä¢ {{ dashboard.money.revenue.transactions }} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
            </div>
            
            <div class="kpi-card {% if dashboard.money.conversion < 1 %}danger{% else %}money{% endif %}">
                <div class="kpi-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø–æ–∫—É–ø–∫—É</div>
                <div class="kpi-value">{{ dashboard.money.conversion }}%</div>
                <div class="kpi-subtitle">
                    {% if dashboard.money.conversion < 0.5 %}
                        üö® –ö—Ä–∏—Ç–∏—á–Ω–æ –Ω–∏–∑–∫–∞—è!
                    {% elif dashboard.money.conversion < 1 %}
                        ‚ö†Ô∏è –ù–∏–∂–µ –Ω–æ—Ä–º—ã
                    {% elif dashboard.money.conversion >= 5 %}
                        üî• –û—Ç–ª–∏—á–Ω–æ!
                    {% else %}
                        ‚úÖ –í –Ω–æ—Ä–º–µ (1-3%)
                    {% endif %}
                </div>
            </div>
            
            <div class="kpi-card {% if dashboard.money.unit_economics.status == 'negative' %}danger{% else %}money{% endif %}">
                <div class="kpi-label">–ú–∞—Ä–∂–∞ –Ω–∞ —é–∑–µ—Ä–∞</div>
                <div class="kpi-value">${{ dashboard.money.unit_economics.margin|floatformat:4 }}</div>
                <div class="kpi-subtitle">
                    ARPU: ${{ dashboard.money.unit_economics.arpu|floatformat:4 }} | 
                    –†–∞—Å—Ö–æ–¥—ã: ${{ dashboard.money.unit_economics.cost_per_user|floatformat:4 }}
                </div>
            </div>
            
            <div class="kpi-card money">
                <div class="kpi-label">–†–∞—Å—Ö–æ–¥—ã –Ω–∞ AI</div>
                <div class="kpi-value">${{ dashboard.money.ai_costs.cost_usd|floatformat:4 }}</div>
                <div class="kpi-subtitle">{{ dashboard.money.ai_costs.requests }} –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Ä¢ {{ dashboard.money.ai_costs.tokens }} —Ç–æ–∫–µ–Ω–æ–≤</div>
            </div>
        </div>
    </div>
    
    <!-- –ë–õ–û–ö 3: –£–î–ï–†–ñ–ê–ù–ò–ï -->
    <div class="dashboard-section">
        <h2 class="section-title">ü™£ –£–¥–µ—Ä–∂–∞–Ω–∏–µ (–î—ã—Ä—è–≤–æ–µ –ª–∏ –≤–µ–¥—Ä–æ?)</h2>
        <div class="kpi-grid">
            <div class="kpi-card retention">
                <div class="kpi-label">Retention Day 1</div>
                <div class="kpi-value">{{ dashboard.retention.day_1.rate }}%</div>
                <div class="retention-bar">
                    <div class="retention-bar-fill {% if dashboard.retention.day_1.rate >= 20 %}good{% elif dashboard.retention.day_1.rate >= 10 %}warning{% else %}bad{% endif %}" 
                         style="width: {{ dashboard.retention.day_1.rate }}%"></div>
                </div>
                <div class="kpi-subtitle">
                    {{ dashboard.retention.day_1.returned }} –∏–∑ {{ dashboard.retention.day_1.cohort_size }} –≤–µ—Ä–Ω—É–ª–∏—Å—å
                    {% if dashboard.retention.day_1.rate < 15 %}‚Ä¢ üö® –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–æ–º!{% endif %}
                </div>
            </div>
            
            <div class="kpi-card retention">
                <div class="kpi-label">Retention Day 7</div>
                <div class="kpi-value">{{ dashboard.retention.day_7.rate }}%</div>
                <div class="retention-bar">
                    <div class="retention-bar-fill {% if dashboard.retention.day_7.rate >= 10 %}good{% elif dashboard.retention.day_7.rate >= 5 %}warning{% else %}bad{% endif %}" 
                         style="width: {{ dashboard.retention.day_7.rate }}%"></div>
                </div>
                <div class="kpi-subtitle">{{ dashboard.retention.day_7.returned }} –∏–∑ {{ dashboard.retention.day_7.cohort_size }} –≤–µ—Ä–Ω—É–ª–∏—Å—å</div>
            </div>
            
            <div class="kpi-card retention">
                <div class="kpi-label">Retention Day 30</div>
                <div class="kpi-value">{{ dashboard.retention.day_30.rate }}%</div>
                <div class="retention-bar">
                    <div class="retention-bar-fill {% if dashboard.retention.day_30.rate >= 5 %}good{% elif dashboard.retention.day_30.rate >= 2 %}warning{% else %}bad{% endif %}" 
                         style="width: {{ dashboard.retention.day_30.rate }}%"></div>
                </div>
                <div class="kpi-subtitle">{{ dashboard.retention.day_30.returned }} –∏–∑ {{ dashboard.retention.day_30.cohort_size }} –≤–µ—Ä–Ω—É–ª–∏—Å—å</div>
            </div>
        </div>
    </div>
    
    <!-- –ì–†–ê–§–ò–ö–ò -->
    <div class="dashboard-section">
        <h2 class="section-title">üìà –î–∏–Ω–∞–º–∏–∫–∞</h2>
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (14 –¥–Ω–µ–π)</div>
                <div class="chart-container">
                    <canvas id="usersChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">üìù –ó–∞–ø–∏—Å–∏ (14 –¥–Ω–µ–π)</div>
                <div class="chart-container">
                    <canvas id="entriesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">üí∞ –î–æ—Ö–æ–¥ (14 –¥–Ω–µ–π)</div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –¢–ê–ë–õ–ò–¶–´ -->
    <div class="dashboard-section">
        <h2 class="section-title">üìä –î–µ—Ç–∞–ª–∏</h2>
        <div class="tables-grid">
            <div class="table-card">
                <div class="table-title">üí≥ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–¢–∏–ø</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–î–∞—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in recent_transactions %}
                        <tr>
                            <td>{{ tx.user }}</td>
                            <td>{{ tx.transaction_type }}</td>
                            <td class="amount-positive">‚≠ê {{ tx.amount_stars }} (${{ tx.amount_usd }})</td>
                            <td>{{ tx.date_created|date:"d.m H:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #9ca3af;">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="table-card">
                <div class="table-title">üèÜ –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–ó–∞–ø–∏—Å–µ–π</th>
                            <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in top_users %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ user }}</td>
                            <td>{{ user.entries_count }}</td>
                            <td>{{ user.subscription_tier|default:"free" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #9ca3af;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
</div>

<script>
    const dashboardData = {{ dashboard_json|safe }};
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    document.addEventListener('DOMContentLoaded', function() {
        // –ì—Ä–∞—Ñ–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const usersCtx = document.getElementById('usersChart').getContext('2d');
        new Chart(usersCtx, {
            type: 'line',
            data: dashboardData.charts.users,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // –ì—Ä–∞—Ñ–∏–∫ –∑–∞–ø–∏—Å–µ–π
        const entriesCtx = document.getElementById('entriesChart').getContext('2d');
        new Chart(entriesCtx, {
            type: 'bar',
            data: dashboardData.charts.entries,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                }
            }
        });
        
        // –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–∞
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        new Chart(revenueCtx, {
            type: 'line',
            data: dashboardData.charts.revenue,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
    
    // –§—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞
    function setPeriod(period) {
        window.location.href = '?period=' + period;
    }
    
    function setCustomPeriod() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        if (startDate && endDate) {
            window.location.href = '?period=custom&start_date=' + startDate + '&end_date=' + endDate;
        }
    }
</script>
{% endblock %}

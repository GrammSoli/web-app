// Prisma Schema for AI Mindful Journal
// PostgreSQL database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserStatus {
  active
  banned
  deleted

  @@map("user_status")
}

enum SubscriptionTier {
  free
  basic
  premium

  @@map("subscription_tier")
}

enum ServiceType {
  gpt_4o_mini    @map("gpt-4o-mini")
  whisper_1      @map("whisper-1")
  deepseek_chat  @map("deepseek-chat")

  @@map("service_type")
}

enum BroadcastStatus {
  draft
  scheduled
  sending
  sent
  failed

  @@map("broadcast_status")
}

enum BroadcastAudience {
  all
  premium
  free

  @@map("broadcast_audience")
}

enum SegmentType {
  system
  dynamic
  static

  @@map("segment_type")
}

enum HabitFrequency {
  daily
  weekdays
  weekends
  custom

  @@map("habit_frequency")
}

enum TransactionType {
  stars_payment
  card_payment
  crypto_payment
  adsgram_reward
  refund

  @@map("transaction_type")
}

// ============================================
// MODELS
// ============================================

model User {
  id                  String            @id @default(uuid()) @db.Uuid
  telegramId          BigInt            @unique @map("telegram_id")
  username            String?           @db.VarChar(255)
  firstName           String?           @map("first_name") @db.VarChar(255)
  lastName            String?           @map("last_name") @db.VarChar(255)
  languageCode        String            @default("ru") @map("language_code") @db.VarChar(10)
  timezone            String            @default("UTC") @db.VarChar(50)

  // Subscription & Balance
  subscriptionTier    SubscriptionTier  @default(free) @map("subscription_tier")
  subscriptionExpiresAt DateTime?       @map("subscription_expires_at") @db.Timestamptz
  balanceStars        Int               @default(0) @map("balance_stars")

  // Settings
  reminderEnabled     Boolean           @default(false) @map("reminder_enabled")
  reminderTime        String?           @map("reminder_time") @db.VarChar(5) // HH:MM format
  privacyBlurDefault  Boolean           @default(false) @map("privacy_blur_default")

  // Aggregated stats
  totalEntriesCount   Int               @default(0) @map("total_entries_count")
  totalVoiceCount     Int               @default(0) @map("total_voice_count")
  totalSpendUsd       Decimal           @default(0) @map("total_spend_usd") @db.Decimal(10, 4)

  // Referral tracking
  referralSource      String?           @map("referral_source") @db.VarChar(100)

  // Status & Admin
  status              UserStatus        @default(active)
  isAdmin             Boolean           @default(false) @map("is_admin")

  // Timestamps
  dateCreated         DateTime          @default(now()) @map("date_created") @db.Timestamptz
  dateUpdated         DateTime          @updatedAt @map("date_updated") @db.Timestamptz

  // Relations
  entries             JournalEntry[]
  usageLogs           UsageLog[]
  transactions        Transaction[]
  subscriptions       Subscription[]
  habits              Habit[]

  @@index([reminderEnabled, status])
  @@map("users")
}

model JournalEntry {
  id                  String            @id @default(uuid()) @db.Uuid
  userId              String            @map("user_id") @db.Uuid
  
  // Content
  textContent         String            @map("text_content") @db.Text
  voiceFileId         String?           @map("voice_file_id") @db.VarChar(255)
  voiceDurationSeconds Int?             @map("voice_duration_seconds")
  isVoice             Boolean           @default(false) @map("is_voice")

  // AI Analysis
  moodScore           Int?              @map("mood_score")
  moodLabel           String?           @map("mood_label") @db.VarChar(50)
  aiTags              Json              @default("[]") @map("ai_tags") @db.JsonB
  aiSummary           String?           @map("ai_summary") @db.Text
  aiSuggestions       String?           @map("ai_suggestions") @db.Text

  // Processing status
  isProcessed         Boolean           @default(false) @map("is_processed")
  processingError     String?           @map("processing_error") @db.Text

  // Timestamps
  dateCreated         DateTime          @default(now()) @map("date_created") @db.Timestamptz
  dateUpdated         DateTime          @updatedAt @map("date_updated") @db.Timestamptz

  // Relations
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageLogs           UsageLog[]

  @@index([userId])
  @@index([userId, dateCreated(sort: Desc)])
  @@index([userId, isVoice])
  @@index([dateCreated(sort: Desc)])
  @@index([moodScore])
  @@map("journal_entries")
}

model UsageLog {
  id                  String            @id @default(uuid()) @db.Uuid
  userId              String            @map("user_id") @db.Uuid
  entryId             String?           @map("entry_id") @db.Uuid

  // Service details
  serviceType         ServiceType       @map("service_type")
  modelName           String            @map("model_name") @db.VarChar(50)

  // Usage metrics
  inputTokens         Int               @default(0) @map("input_tokens")
  outputTokens        Int               @default(0) @map("output_tokens")
  durationSeconds     Int               @default(0) @map("duration_seconds")

  // Cost
  costUsd             Decimal           @map("cost_usd") @db.Decimal(10, 6)

  // Metadata
  requestId           String?           @map("request_id") @db.VarChar(100)
  latencyMs           Int?              @map("latency_ms")

  // Timestamp
  dateCreated         DateTime          @default(now()) @map("date_created") @db.Timestamptz

  // Relations
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  entry               JournalEntry?     @relation(fields: [entryId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, serviceType, dateCreated(sort: Desc)])
  @@index([serviceType])
  @@index([dateCreated(sort: Desc)])
  @@map("usage_logs")
}

model Transaction {
  id                    String            @id @default(uuid()) @db.Uuid
  userId                String            @map("user_id") @db.Uuid

  // Transaction details
  transactionType       TransactionType   @map("transaction_type")
  amountStars           Int               @default(0) @map("amount_stars")
  amountUsd             Decimal           @default(0) @map("amount_usd") @db.Decimal(10, 4)
  currency              String?           @db.VarChar(10)
  
  // Invoice ID for idempotency (Telegram charge ID or CryptoPay invoice ID)
  invoiceId             String?           @unique @map("invoice_id") @db.VarChar(255)

  // Telegram payment info (legacy, use invoiceId)
  telegramPaymentId     String?           @map("telegram_payment_id") @db.VarChar(255)
  telegramPaymentChargeId String?         @map("telegram_payment_charge_id") @db.VarChar(255)
  
  // Additional metadata
  metadata              Json?             @db.JsonB

  // Status
  isSuccessful          Boolean           @default(true) @map("is_successful")
  failureReason         String?           @map("failure_reason") @db.Text

  // Timestamp
  dateCreated           DateTime          @default(now()) @map("date_created") @db.Timestamptz

  // Relations
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription          Subscription?

  @@index([userId])
  @@index([transactionType])
  @@index([dateCreated(sort: Desc)])
  @@map("transactions")
}

model Subscription {
  id                  String            @id @default(uuid()) @db.Uuid
  userId              String            @map("user_id") @db.Uuid
  transactionId       String?           @unique @map("transaction_id") @db.Uuid

  // Subscription details
  tier                SubscriptionTier
  startsAt            DateTime          @default(now()) @map("starts_at") @db.Timestamptz
  expiresAt           DateTime          @map("expires_at") @db.Timestamptz

  // Pricing at time of purchase
  priceStars          Int               @map("price_stars")
  priceUsd            Decimal           @map("price_usd") @db.Decimal(10, 4)

  // Status
  isActive            Boolean           @default(true) @map("is_active")
  cancelledAt         DateTime?         @map("cancelled_at") @db.Timestamptz

  // Timestamps
  dateCreated         DateTime          @default(now()) @map("date_created") @db.Timestamptz
  dateUpdated         DateTime          @updatedAt @map("date_updated") @db.Timestamptz

  // Relations
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction         Transaction?      @relation(fields: [transactionId], references: [id])

  @@index([userId])
  @@index([isActive, expiresAt])
  @@map("subscriptions")
}

model Broadcast {
  id                  String            @id @default(uuid()) @db.Uuid

  // Content
  title               String            @db.VarChar(255)
  messageText         String            @map("message_text") @db.Text
  messagePhotoUrl     String?           @map("message_photo_url") @db.Text

  // Targeting (legacy - kept for backward compatibility)
  targetAudience      BroadcastAudience @default(all) @map("target_audience")
  
  // New: Segment-based targeting (preferred)
  segmentId           String?           @map("segment_id") @db.Uuid
  segment             UserSegment?      @relation(fields: [segmentId], references: [id], onDelete: SetNull)

  // Scheduling
  scheduledAt         DateTime?         @map("scheduled_at") @db.Timestamptz

  // Execution status
  status              BroadcastStatus   @default(draft)
  startedAt           DateTime?         @map("started_at") @db.Timestamptz
  completedAt         DateTime?         @map("completed_at") @db.Timestamptz

  // Stats
  totalRecipients     Int               @default(0) @map("total_recipients")
  sentCount           Int               @default(0) @map("sent_count")
  failedCount         Int               @default(0) @map("failed_count")

  // Error tracking
  lastError           String?           @map("last_error") @db.Text

  // Timestamps
  dateCreated         DateTime          @default(now()) @map("date_created") @db.Timestamptz
  dateUpdated         DateTime          @updatedAt @map("date_updated") @db.Timestamptz
  userCreated         String?           @map("user_created") @db.Uuid
  userUpdated         String?           @map("user_updated") @db.Uuid

  @@index([status])
  @@index([segmentId])
  @@map("broadcasts")
}

// ============================================
// USER SEGMENTS
// ============================================

model UserSegment {
  id                  String            @id @default(uuid()) @db.Uuid
  
  // Basic info
  name                String            @db.VarChar(100)
  description         String?           @db.Text
  slug                String            @unique @db.VarChar(50)
  
  // Type
  segmentType         SegmentType       @default(dynamic) @map("segment_type")
  isSystem            Boolean           @default(false) @map("is_system")
  
  // Dynamic filter (JSON rules)
  filterRules         Json?             @map("filter_rules") @db.JsonB
  
  // Static user list
  staticUserIds       String[]          @map("static_user_ids") @db.Uuid
  
  // Cached stats
  cachedUserCount     Int               @default(0) @map("cached_user_count")
  cacheUpdatedAt      DateTime?         @map("cache_updated_at") @db.Timestamptz
  
  // Timestamps
  dateCreated         DateTime          @default(now()) @map("date_created") @db.Timestamptz
  dateUpdated         DateTime          @updatedAt @map("date_updated") @db.Timestamptz
  
  // Relations
  broadcasts          Broadcast[]
  
  @@index([slug])
  @@index([segmentType])
  @@map("user_segments")
}

model AppSetting {
  id                  String            @id @default(uuid()) @db.Uuid
  key                 String            @unique @db.VarChar(100)
  value               Json              @db.JsonB
  description         String?           @db.Text

  dateCreated         DateTime          @default(now()) @map("date_created") @db.Timestamptz
  dateUpdated         DateTime          @updatedAt @map("date_updated") @db.Timestamptz

  @@map("app_settings")
}

model TrafficSource {
  id                  String            @id @default(uuid()) @db.Uuid
  
  slug                String            @unique @db.VarChar(100)
  name                String            @db.VarChar(255)
  description         String?           @db.Text
  
  sourceType          String            @default("utm") @map("source_type") @db.VarChar(50)
  
  // UTM parameters
  utmSource           String?           @map("utm_source") @db.VarChar(100)
  utmMedium           String?           @map("utm_medium") @db.VarChar(100)
  utmCampaign         String?           @map("utm_campaign") @db.VarChar(100)
  
  // Cached stats
  totalUsers          Int               @default(0) @map("total_users")
  totalPayingUsers    Int               @default(0) @map("total_paying_users")
  totalRevenueUsd     Decimal           @default(0) @map("total_revenue_usd") @db.Decimal(12, 4)
  
  isActive            Boolean           @default(true) @map("is_active")
  
  dateCreated         DateTime          @default(now()) @map("date_created") @db.Timestamptz
  dateUpdated         DateTime          @updatedAt @map("date_updated") @db.Timestamptz

  @@index([slug])
  @@index([isActive])
  @@map("traffic_sources")
}

// ============================================
// HABITS TRACKER
// ============================================

model Habit {
  id                  String            @id @default(uuid()) @db.Uuid
  userId              String            @map("user_id") @db.Uuid
  
  // Habit details
  name                String            @db.VarChar(100)
  emoji               String            @default("âœ¨") @db.VarChar(10)
  color               String            @default("#6366f1") @db.VarChar(20) // Brand color
  
  // Schedule
  frequency           HabitFrequency    @default(daily)
  customDays          Int[]             @default([]) @map("custom_days") // 0=Sun, 1=Mon, etc.
  reminderTime        String?           @map("reminder_time") @db.VarChar(5) // HH:MM
  
  // Stats (cached for performance)
  currentStreak       Int               @default(0) @map("current_streak")
  longestStreak       Int               @default(0) @map("longest_streak")
  totalCompletions    Int               @default(0) @map("total_completions")
  
  // Order & Status
  sortOrder           Int               @default(0) @map("sort_order")
  isActive            Boolean           @default(true) @map("is_active")
  isArchived          Boolean           @default(false) @map("is_archived")
  
  // Timestamps
  dateCreated         DateTime          @default(now()) @map("date_created") @db.Timestamptz
  dateUpdated         DateTime          @updatedAt @map("date_updated") @db.Timestamptz

  // Relations
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  completions         HabitCompletion[]

  @@index([userId, isActive])
  @@index([userId, isArchived])
  @@map("habits")
}

model HabitCompletion {
  id                  String            @id @default(uuid()) @db.Uuid
  habitId             String            @map("habit_id") @db.Uuid
  userId              String            @map("user_id") @db.Uuid
  
  // Completion date (without time, for easy querying)
  completedDate       DateTime          @map("completed_date") @db.Date
  
  // Optional note
  note                String?           @db.VarChar(500)
  
  // Timestamp
  dateCreated         DateTime          @default(now()) @map("date_created") @db.Timestamptz

  // Relations
  habit               Habit             @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([habitId, completedDate]) // One completion per habit per day
  @@index([habitId, completedDate])
  @@index([userId, completedDate])
  @@map("habit_completions")
}
